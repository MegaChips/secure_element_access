# セキュアエレメントアクセス手順

MRF61_A MCU development boardのセキュアエレメントにアクセスする場合、[Cortex-Debugでデバッグ](https://github.com/MegaChips/secure_element_access/blob/master/docs/firmware_build_guide.md)を行うか、ファームウェアバイナリをMRF61_A MCU development boardに書き込む必要があります。



## ファームウェアの書き込み

1. ファームウェア書き込みツール起動

   File explorerで`C:\workspace\tools\flash_write`を開きます。

   `flash.bat`を実行し、ファームウェア書き込みツールを起動します。

2. ファームウェアイメージ書き込み

   **Select**ボタンを押下し、`C:\workspace\firmware\secure_element_access\build\secure_element_access.bin`を選択し書き込みを実行します。



## 事前準備

必要なライブラリをインストールするために以下のコマンドを実行してください。

```
cd C:\workspace\firmware\secure_element_access
pip install -r requirements.txt
```



## MACアドレス/デバイス証明書の読み出し

1. プロジェクト開始

   VS Codeを起動し、`C:\workspace\firmware\secure_element_access`を開きます。

2. 外部Flash書き込みツール起動

   メニューバーからターミナルを選択し、**タスクの実行**から**secure element reader**タスクを実行し、セキュアエレメントデータ読み出しツールを起動します。

3. ボードリセット

   MRF61_A MCU development boardの**Reset**ボタンを押下し、ボードをリセットします。

4. データ読み出し

   1. COMポート設定

      MRF61_A MCU development boardと接続されているCOMポートを選択します。ボーレート、データビット、ストップビットやパリティは自動で設定されます。

   2. 読み出しデータ保存先選択

      **参照**ボタンから、セキュアエレメントから読み出したデータの保存先を選択します。ファイル形式はCSVです。

   3. セキュアエレメントデータ読み出し処理

      **実行**ボタンを押下し、セキュアエレメントからデータ読み出し処理を実行します。



## セキュアブート用公開鍵の書き込み

1. プロジェクト開始

   VS Codeを起動し、`C:\workspace\firmware\secure_element_access`を開きます。

2. 外部Flash書き込みツール起動

   メニューバーからターミナルを選択し、**タスクの実行**から**secure element writer**タスクを実行し、セキュアエレメントデータ書き込みツールを起動します。

3. ボードリセット

   MRF61_A MCU development boardの**Reset**ボタンを押下し、ボードをリセットします。

4. セキュアブート用公開鍵書き込み

   1. COMポート設定

      MRF61_A MCU development boardと接続されているCOMポートを選択します。ボーレート、データビット、ストップビットやパリティは自動で設定されます。

   2. セキュアブート用公開鍵選択

      **参照**ボタンから、セキュアエレメントへ書き込む公開鍵ファイルを選択します。公開鍵はPEM形式である必要があります。

   3. スロットロック選択

      セキュアブート用公開鍵の書き換えを防止する場合、**公開鍵書き込み後にスロットをロックする**をチェックします。

      -----

      [重要]

      スロットをロックした後はアンロックはできません。

      -----

   4. セキュアエレメント書き込み処理

      **実行**ボタンを押下し、セキュアエレメントへのデータ書き込み処理を実行します。



## うまくいかない場合

エラーが出力された場合は、各エラーメッセージに対する以下の対処方法を確認してください。

| エラーメッセージ                 | 対処方法                                                     |
| -------------------------------- | ------------------------------------------------------------ |
| ポートが開けません。             | ・ポートが選択されていることを確認してください。<br />・指定したポートにデバイスが接続されていることを確認してください。 |
| データの読み込みに失敗しました。 | ・指定したポートが正しいか確認してください。<br />・デバイスを接続し直して再度実行ボタンを押下してください。それでもうまくいかない場合、ファームウェアが正常に書き込まれていない可能性があります。 |
| データの書き込みに失敗しました。 | ・指定したポートが正しいか確認してください。<br />・デバイスを接続し直して再度実行ボタンを押下してください。それでもうまくいかない場合、ファームウェアが正常に書き込まれていない可能性があります。 |
| 指定したファイルが存在しません。 | ・ファイルが選択されているか確認してください。               |
| ファイルが開けません。           | ・ファイルが別のアプリケーションによって起動されていないか確認してください。 |



## コマンドベースの操作

コマンドベースの操作によるセキュアエレメントへのアクセスも可能です。

次の操作は`C:\workspace\firmware\secure_element_access\python`にて行ってください。



以下のコマンドによって各サブコマンドを呼ぶことができます。

```
python command.py <サブコマンド名>　[サブコマンド引数]
```



以下では各サブコマンドについて説明します。



#### get_port_list

##### コマンド

```
python command.py get_port_list
```

##### 説明

シリアルポートの一覧を表示します。



#### read_mac_address

##### コマンド

```
python command.py read_mac_address <ポート名>
```

##### 説明

セキュアエレメントに格納されたMACアドレスを読み出して表示します。

##### 引数

- ポート名：シリアルポートを指定してください。シリアルポートの一覧はget_port_listサブコマンドで確認できます。



#### read_certificate

##### コマンド

```
python command.py read_certificate <ポート名>
```

##### 説明

セキュアエレメントに格納されたデバイス証明書を読み出して表示します。

##### 引数

- ポート名：シリアルポートを指定してください。シリアルポートの一覧はget_port_listサブコマンドで確認できます。



#### read_device_infos

##### コマンド

```
python command.py read_device_infos <ポート名> <CSVファイル名>
```

##### 説明

セキュアエレメントに格納されたデータを読み出してCSVファイルに書き込みます。CSVファイルにすでにデータがある場合は次の行に追記されます。読み出すデータは以下です。

- MACアドレス
- デバイス証明書

##### 引数

- ポート名：シリアルポートを指定してください。シリアルポートの一覧はget_port_listサブコマンドで確認できます。
- CSVファイル名：CSVファイル名あるいはそのファイルまでのパスを指定してください。



#### write_public_key

##### コマンド

```
python command.py write_public_key <ポート名> <公開鍵ファイル名>
```

##### 説明

引数に渡されたファイルから公開鍵を読み出し、セキュアエレメントに書き込みます。公開鍵はPEM形式である必要があります。

##### 引数

- ポート名：シリアルポートを指定してください。シリアルポートの一覧はget_port_listサブコマンドで確認できます。
- 公開鍵ファイル名：公開鍵ファイル名あるいはそのファイルまでのパスを指定してください。



#### lock_slot

##### コマンド

```
python command.py lock_slot <ポート名> <スロット番号>
```

##### 説明

指定されたセキュアエレメントのスロットをロックします。一度ロックしたスロットは変更ができません。

##### 引数

- ポート名：シリアルポートを指定してください。シリアルポートの一覧はget_port_listサブコマンドで確認できます。
- スロット番号：ロックするスロットの番号を指定してください。

